"use strict";var superagent=require("superagent"),path=require("path"),fs=require("fs"),TURBO_URL="https://turbo-dashboard.herokuapp.com",PLATFORM_VERCTOR_URL="https://platform.turbo360-vector.com",NODE_MODULES_PATH="win32"==process.platform?"node_modules\\vertex360\\dist\\vertex":"node_modules/vertex360/dist/vertex",STANDARD_HEADERS={"Content-Type":"application/json"},BUCKET="turbo360-vertex",currentSite=null,generateErrorCallback=function(e,t,n){return{isBase64Encoded:!1,statusCode:t,headers:n||STANDARD_HEADERS,body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},generateSuccessCallback=function(e,t){return{isBase64Encoded:!1,statusCode:200,headers:t||STANDARD_HEADERS,body:JSON.stringify({confirmation:"success",data:e})}},logString=function(e){var t=e.httpMethod.toLowerCase(),n=t.toUpperCase()+" "+e.path;return null!=e.headers["User-Agent"]&&(n+=" "+e.headers["User-Agent"]),null==e.requestContext?n:null==e.requestContext.identity?n:null==e.requestContext.identity.sourceIp?n:n+=" "+e.requestContext.identity.sourceIp},writeFile=function(e,t){return new Promise(function(n,r){fs.writeFile(e,t,function(e){if(e)return void r(e);n(t)})})},isValidApp=function(e){return null==e.TURBO_APP_ID?"TURBO_APP_ID":"<TURBO_APP_ID>"==e.TURBO_APP_ID?"TURBO_APP_ID":e.TURBO_APP_ID.length<20?"TURBO_APP_ID":null==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":"<TURBO_APP_SLUG>"==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":e.TURBO_APP_SLUG.length<6?"TURBO_APP_SLUG":null==e.TURBO_API_KEY?"TURBO_API_KEY":"<TURBO_API_KEY>"==e.TURBO_API_KEY?"TURBO_API_KEY":e.TURBO_API_KEY.length<20?"TURBO_API_KEY":null},getRequest=function(e,t,n){return null==n&&(n={Accept:"application/json"}),new Promise(function(r,o){superagent.get(e).query(t).set(n).end(function(e,t){if(e)return void o(e);var i=null;"application/json"==n.Accept&&(i=t.body||t.text),r(i)})})},postRequest=function(e,t,n){return null==n&&(n={Accept:"application/json"}),new Promise(function(r,o){superagent.post(e).send(t).set(n).end(function(e,t){if(e)return void o(e);var i=null;"application/json"==n.Accept&&(i=t.body||t.text),r(i)})})},fetchTextFile=function(e){return new Promise(function(t,n){superagent.get(e).query(null).end(function(e,r){if(e)return void n(e);t(r.text)})})},resetPage=function(e,t){return new Promise(function(n,r){if(null==e)return void r(new Error("Missing pageName argument"));if(null==t)return void r(new Error("Missing appslug argument"));var o=e+".txt";fetchTextFile("https://s3.amazonaws.com/turbo360-vertex/pages/"+t+"/"+o).then(function(e){fs.writeFileSync("/tmp/"+o,e);var t=JSON.parse(e);n(t)}).catch(function(e){r(e)})})},fetchSite=function(e,t){return null==t&&(t=!0),new Promise(function(n,r){if(null!=currentSite&&1==t)return void n(currentSite);var o=TURBO_URL+"/api/site/"+e;superagent.get(o).query(null).set("Accept","application/json").end(function(e,t){if(e)return void r(e);var o=t.body;if("success"!=o.confirmation)return void r(new Error(o.message));currentSite=o.result,n(currentSite)})})},globalConfig=function(e){return new Promise(function(t,n){if("dev"==e.TURBO_ENV){var r=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return void fs.readFile(r,"utf8",function(e,r){if(e)return void n(e);try{t(JSON.parse(r))}catch(e){n(e)}})}var o=isValidApp(e);if(null!=o)return void n(new Error("Please Set Your "+o));fetchSite(e.TURBO_APP_ID,!1).then(function(r){if(r.api.key!=e.TURBO_API_KEY)return void n(new Error("Unauthorized"));currentSite=r,t(r.globalConfig)}).catch(function(e){n(e)})})},proxyPlatformFunction=function(e,t,n){return new Promise(function(r,o){null==n&&(n={Accept:"application/json"});var i=PLATFORM_VERCTOR_URL+"/"+e;superagent.post(i).send(t).set(n).end(function(e,t){if(e)return void o(e);var n=t.body;r(n)})})},checkPageConfig=function(e,t){var n=__dirname.replace("node_modules/vertex360/dist/vertex","");return new Promise(function(r,o){var i=n+"/pages/"+e+".json";if(0==fs.existsSync(i))return void r(null);var a="/tmp/"+e+".txt";if(fs.existsSync(a)){var u=fs.readFileSync(a,"utf8");try{var s=JSON.parse(u);return void r(s)}catch(e){return void r(null)}}else{var c="https://s3.amazonaws.com/"+BUCKET+"/pages/"+t+"/"+e+".txt",l=null;fetchTextFile(c).then(function(e){return l=JSON.parse(e),writeFile(a,e)}).then(function(e){r(l)}).catch(function(t){if(null!=t.message&&"Forbidden"==t.message){var n=e+".json",r=e+" config file ("+n+") not found on staging environment. To fix: $ turbo page "+e+". REFERENCE - https://docs.turbo360.co/page-configuration";return void o(new Error(r))}o(t)})}})},parseBody=function(e){if(null==e.body)return null;var t={};try{t=JSON.parse(e.body)}catch(r){var n=e.body.split("&");n.forEach(function(e,n){var r=e.split("=");2==r.length&&(t[r[0]]=decode(r[1]))})}return t};module.exports={get:getRequest,post:postRequest,fetchTextFile:fetchTextFile,fetchSite:fetchSite,globalConfig:globalConfig,isValidApp:isValidApp,resetPage:resetPage,logString:logString,generateSuccessCallback:generateSuccessCallback,generateErrorCallback:generateErrorCallback,checkPageConfig:checkPageConfig,parseBody:parseBody,slugVersion:function(e,t){var n=e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"");if(null==t)return n.toLowerCase();if(t<=0)return n.toLowerCase();for(var r="",o="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<t;i++)r+=o.charAt(Math.floor(Math.random()*o.length));return n.toLowerCase()+"-"+r},truncateText:function(e,t){return e.length<t?e:e.substring(0,t)+"..."},formattedDate:function(e){var t={weekday:"long",year:"numeric",month:"long",day:"numeric"};return null==e&&(e=new Date),e.toLocaleDateString("en-US",t)},scrapeInstagram:function(e,t){return null==t&&(t=70),new Promise(function(n,r){getRequest("https://www.instagram.com/"+e+"/?__a=1").then(function(e){var r=[];return null==e?void n(r):null==e.graphql?void n(r):null==e.graphql.user?void n(r):null==e.graphql.user.edge_owner_to_timeline_media?void n(r):null==e.graphql.user.edge_owner_to_timeline_media.edges?void n(r):(e.graphql.user.edge_owner_to_timeline_media.edges.forEach(function(e){if(null!=e.node){var n={};n.shortcode=e.node.shortcode,n.image=e.node.thumbnail_src,n.caption=e.node.edge_media_to_caption.edges[0].node.text,n.caption=n.caption.substring(0,t)+"...",r.push(n)}}),void n(r))}).catch(function(e){r(e)})})},scrapePreview:function(e,t,n){return proxyPlatformFunction("scrapepreview",{text:e,limit:t},n)},execute:function(e,t,n){return proxyPlatformFunction(e,t,n)}};