"use strict";var adminRest=require("./adminRest"),utils=require("./utils"),handleTask=function(e){var r=["post"];return new Promise(function(t,n){if(-1==r.indexOf(e.method))return void n(new Error("Invalid HTTP method: "+e.method));var a=utils.parseBody(e.event),i=a.task;if(null==i)return void n(new Error("Missing task parameter"));if("resetpage"==i){var l=a.page;if(null==l)return void n(new Error("Missing page parameter"));var o=a.appslug;return null==o?void n(new Error("Missing appslug parameter")):void utils.resetPage(l,o).then(function(e){t(e)}).catch(function(e){n(e)})}n(new Error("Invalid task parameter: "+i))})};module.exports=function(e,r,t){var n=r.path,a=n.split("/"),i=[],l=r.httpMethod.toLowerCase();if(a.forEach(function(e){e.length>0&&"/"!=e&&i.push(e)}),0==i.length){var o=new Error("invalid path. must folow /api/:resource/:id");return void t(null,utils.generateErrorCallback(o,500))}if("api"!=i[0]){var o=new Error("invalid path. must folow /api/:resource/:id");return void t(null,utils.generateErrorCallback(o,500))}var s={method:l,event:r};if(1==i.length?s.type="post"==l?"task":"schema":2==i.length?(s.type="collection",s.resource=i[1].trim().toLowerCase()):(s.type="record",s.resource=i[1].trim().toLowerCase(),s.id=i[2].trim()),"task"==s.type)return void handleTask(s).then(function(e){t(null,utils.generateSuccessCallback(e))}).catch(function(e){t(null,utils.generateErrorCallback(e,500))});var u=e.opts.controllers||null;if(!u)return void t(null,utils.generateErrorCallback(new Error("controllers not defined. check config settings."),500));adminRest(u,r,s).then(function(e){t(null,utils.generateSuccessCallback(e))}).catch(function(e){t(null,utils.generateErrorCallback(e,500))})};