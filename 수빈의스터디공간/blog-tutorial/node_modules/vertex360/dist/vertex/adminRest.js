"use strict";var decode=require("urldecode"),utils=require("./utils"),handleSchemaRequest=function(e,t){if(-1==["get","post"].indexOf(e.method))throw new Error("Invalid HTTP method: "+e.method);var n=[];return Object.keys(t).forEach(function(e){var r=t[e],o=new r;n.push({name:e,collectionName:o.collectionName(),schema:o.schema()})}),n},handleCollectionRequest=function(e,t){return new Promise(function(n,r){if(-1==["get","post"].indexOf(e.method))return void r(new Error("Invalid HTTP method: "+e.method));var o=t[e.resource];if(null==o)return void r(new Error("invalid resource: "+e.resource));var i=new o;if("get"==e.method){var u=e.event.queryStringParameters||{};i.get(u).then(function(e){n(e)}).catch(function(e){r(e)})}else if("post"==e.method){var c=utils.parseBody(e.event);if(null==c)return void r(new Error("Missing request body."));i.post(c).then(function(e){n(e)}).catch(function(e){r(e)})}else r(new Error("invalid HTTP method: "+e.method))})},handleRecordRequest=function(e,t){var n=["get","put","delete"];return new Promise(function(r,o){if(-1==n.indexOf(e.method))return void o(new Error("Invalid HTTP method: "+e.method));var i=t[e.resource];if(null==i)return void o(new Error("invalid resource: "+e.resource));var u=new i;if("get"==e.method&&u.getById(e.id).then(function(e){r(e)}).catch(function(e){o(e)}),"put"==e.method){var c=utils.parseBody(e.event);if(null==c)return void o(new Error("Missing request body"));u.put(e.id,c).then(function(e){r(e)}).catch(function(e){o(e)})}"delete"==e.method&&function(){var t=e.id;u.delete(t).then(function(e){r({id:t})}).catch(function(e){o(e)})}()})};module.exports=function(e,t,n){return new Promise(function(t,r){if("schema"!=n.type)return"collection"==n.type?void handleCollectionRequest(n,e).then(function(e){t(e)}).catch(function(e){r(e)}):"record"==n.type?void handleRecordRequest(n,e).then(function(e){t(e)}).catch(function(e){r(e)}):void r(new Error("Invalid Request"));try{var o=handleSchemaRequest(n,e);return void t(o)}catch(e){return void r(e)}})};