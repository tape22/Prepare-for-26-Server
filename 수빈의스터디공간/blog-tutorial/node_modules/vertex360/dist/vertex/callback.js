"use strict";var fs=require("fs"),Mustache=require("mustache"),path=require("path"),cookie=require("cookie"),sessions=require("client-sessions"),decode=require("urldecode"),recursive=require("recursive-readdir"),utils=require("./utils"),BUCKET="turbo360-vertex",SESSION_COOKIE_NAME="vertexSession",shouldClearSession=!1,proxyVertexSession=function(e,n){var r={set:function(r,t,i){r==e&&(n.vertexSessionChanged=!0,r[t]=i)}};return new Proxy(e,r)},readFile=function(e){return new Promise(function(n,r){fs.readFile(e,"utf8",function(t,i){if(t)return void r(new Error("File Not Found: "+e));n(i)})})},writeFile=function(e,n){return new Promise(function(r,t){fs.writeFile(e,n,function(e){if(e)return void t(e);r(n)})})},readRecursiveDirectories=function(e){return new Promise(function(n,r){var t=[];if(!fs.existsSync(e))return void n(t);recursive(e,function(e,i){if(e)return void r(e);i.forEach(function(e){var n={};n.path=e;var r=e.split("/"),i=r[r.length-1];n.name=i.split(".")[0],t.push(n)}),n(t)})})},renderMustache=function(e){return new Promise(function(n,r){var t=e.template;if(null==t)return void r(new Error("Missing template"));var i=e.data;if(null==i)return void r(new Error("Missing data"));var s=e.partials||{};try{var o=i||{};n(Mustache.render(t,o,s))}catch(e){r(e)}})},getCookieName=function(e){var n=SESSION_COOKIE_NAME;return null!=e&&null!=e.session&&(n=e.session.cookieName||SESSION_COOKIE_NAME),n},setVertexSession=function(e,n,r){var t=getCookieName(r);if(1==shouldClearSession)return n["Set-Cookie"]=t+"=deleted; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",shouldClearSession=!1,n;if(0==e.vertexSessionChanged)return n;var i=e[t]||{};if(delete i.reset,0==Object.keys(i).length)return n;var s=JSON.stringify(i),o=sessions.util.encode({cookieName:t,secret:"abc"},s,null,null);return n["Set-Cookie"]=t+"="+o+"; path=/;",n},checkPageConfig=function(e,n){var r=__dirname.replace("node_modules/vertex360/dist/vertex","");return new Promise(function(t,i){var s=r+"/pages/"+e+".json";if(0==fs.existsSync(s))return void t(null);var o="/tmp/"+e+".txt";if(fs.existsSync(o)){var a=fs.readFileSync(o,"utf8");try{var u=JSON.parse(a);return void t(u)}catch(e){return void t(null)}}else{var c="https://s3.amazonaws.com/"+BUCKET+"/pages/"+n+"/"+e+".txt",d=null;utils.fetchTextFile(c).then(function(e){return d=JSON.parse(e),writeFile(o,e)}).then(function(e){t(d)}).catch(function(n){if(null!=n.message&&"Forbidden"==n.message){var r=e+".json",t=e+" config file ("+r+") not found on staging environment. To fix: $ turbo page "+e+". REFERENCE - https://docs.turbo360.co/page-configuration";return void i(new Error(t))}i(n)})}})},configureResponse=function(e,n,r){var t="views";return null!=r&&(t=r.views||"views"),{statusCode:200,setHeader:function(e,n){({})[e]=n},json:function(e){n(null,{isBase64Encoded:!1,statusCode:200,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},data:function(r){r.req=e,n(null,{isBase64Encoded:!1,statusCode:200,headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})},send:function(t){var i={"Content-Type":"text/plain"};n(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,i,r),headers:i,body:t})},redirect:function(t){var i={Location:t};n(null,{isBase64Encoded:!1,statusCode:301,headers:setVertexSession(e,i,r),headers:i,body:t})},render:function(i,s){var o=__dirname.replace("node_modules/vertex360/dist/vertex",""),a=i,u={},c=null,d=null;checkPageConfig(i,e.headers["Turbo-Vertex-App"]).then(function(r){null==s&&(s={}),null==s.page&&null!=r&&(s.page=r);var u=e.headers["turbo-vertex-client"];if(null!=u&&"widget"==u){var c={"Content-Type":"application/json"};return s.pageName=s.pageName||i,void n(null,{isBase64Encoded:!1,statusCode:200,headers:c,body:JSON.stringify(s)})}return d=s||{},readFile(o+"/"+t+"/"+a+".mustache")}).then(function(e){return c=e,readRecursiveDirectories(o+"/"+t+"/partials")}).then(function(e){return e.forEach(function(e,n){e.path.indexOf(".mustache")>-1&&(u[e.name]=fs.readFileSync(e.path,"utf8"))}),renderMustache({template:c,data:d,partials:u})}).then(function(t){n(null,{isBase64Encoded:!1,statusCode:200,headers:setVertexSession(e,{"Content-Type":"text/html"},r),body:t})}).catch(function(e){n(null,{isBase64Encoded:!1,statusCode:404,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:e.message})})})}}},clearSession=function(){shouldClearSession=!0},bindMiddleware=function(e,n,r){return new Promise(function(t,i){if(null==r)return void t({req:e,res:n});if(0==r.length)return void t({req:e,res:n});var s=0,o=function(){if(!(s<r.length))return void t({req:e,res:n});(0,r[s])(e,n,function(){s+=1,o()})};o()})};module.exports=function(e,n,r,t,i,s){var o={};if(null!=e.body)try{o=JSON.parse(e.body)}catch(n){var a=e.body.split("&");a.forEach(function(e,n){var r=e.split("=");2==r.length&&(o[r[0]]=decode(r[1]))})}var u=e.path,c=e.queryStringParameters||{},d=Object.keys(c);d.length>0&&(u+="?",d.forEach(function(e,n){c[e]&&(u+=e+"="+c[e])}));var l={query:c,body:o,headers:e.headers,vertexSessionChanged:!1,method:e.httpMethod.toUpperCase(),url:u},f=getCookieName(t),h={reset:clearSession};l[f]=proxyVertexSession(h,l),null!=r&&(l.params=r.params);var v=e.headers.Cookie;if(null==v){var p=configureResponse(l,n,t);return void bindMiddleware(l,p,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}var g=cookie.parse(v);if(null==g[f]){var p=configureResponse(l,n,t);return void bindMiddleware(l,p,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}try{var S=sessions.util.decode({cookieName:f,secret:"abc"},g[f]);if(null==S){var m=configureResponse(l,n,t);return void bindMiddleware(l,m,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}if(null==S.content){var y=configureResponse(l,n,t);return void bindMiddleware(l,y,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}var h=JSON.parse(S.content);h.reset=clearSession,l[f]=proxyVertexSession(h,l);var p=configureResponse(l,n,t);bindMiddleware(l,p,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}catch(e){l[f]=g[f];var p=configureResponse(l,n,t);bindMiddleware(l,p,i).then(function(e){return s(null,{req:e.req,res:e.res})}).catch(function(e){reject(e)})}};